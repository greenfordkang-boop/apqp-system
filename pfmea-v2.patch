From 6e6b8a48570b5bd4bde9ddcfe9dc57c93593caac Mon Sep 17 00:00:00 2001
From: greenfordkang-boop <greenfordkang@gmail.com>
Date: Fri, 6 Feb 2026 07:36:14 +0000
Subject: [PATCH] =?UTF-8?q?feat:=20PFMEA=20=EA=B8=B0=EB=B3=B8=EC=A0=95?=
 =?UTF-8?q?=EB=B3=B4=20=ED=97=A4=EB=8D=94=20+=20=EC=88=98=EB=8F=99=20?=
 =?UTF-8?q?=ED=95=AD=EB=AA=A9=EC=B6=94=EA=B0=80=20+=20AI=20=EA=B2=80?=
 =?UTF-8?q?=ED=86=A0=20=EC=9B=8C=ED=81=AC=ED=94=8C=EB=A1=9C=EC=9A=B0?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Product에 차종(vehicle_model), 품번(part_number) 필드 추가
- PFMEA/CP/SOP/IS 문서헤더에 doc_number, author 필드 추가
- PFMEA 페이지: 고객사/차종/품명/품번 기본정보 표시
- 항목 추가: 사용자가 공정/고장모드/잠재영향 입력
- AI 검토: S/O/D/원인/예방관리/검출관리/권장조치 자동완성
- 승인 시 버전 자동 증가 + 문서번호 자동 생성
- migration_v2.sql: ALTER TABLE로 신규 컬럼 추가

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
---
 src/app/documents/pfmea/[id]/page.tsx | 792 +++++++++++++++-----------
 src/app/products/new/page.tsx         |  36 +-
 src/lib/store.ts                      | 139 +++++
 supabase/migration_v2.sql             |  24 +
 4 files changed, 658 insertions(+), 333 deletions(-)
 create mode 100644 supabase/migration_v2.sql

diff --git a/src/app/documents/pfmea/[id]/page.tsx b/src/app/documents/pfmea/[id]/page.tsx
index 6a8e3dc..7c62c45 100644
--- a/src/app/documents/pfmea/[id]/page.tsx
+++ b/src/app/documents/pfmea/[id]/page.tsx
@@ -1,18 +1,33 @@
 'use client';
 
-import { use, useState, useEffect } from 'react';
+import { use, useState, useEffect, useCallback } from 'react';
 import Link from 'next/link';
-import { pfmeaStore, characteristicStore, productStore } from '@/lib/store';
-import type { PfmeaHeader, PfmeaLine } from '@/lib/store';
+import {
+  pfmeaStore,
+  characteristicStore,
+  productStore,
+  aiReviewPfmeaLine,
+  generateDocNumber,
+} from '@/lib/store';
+import type { PfmeaHeader, PfmeaLine, Product, Characteristic } from '@/lib/store';
 
 type EditingLine = PfmeaLine;
 
-interface Product {
-  id: string;
-  name: string;
-  code: string;
+// 신규 항목 입력용 타입
+interface NewLineInput {
+  process_step: string;
+  characteristic_id: string;
+  potential_failure_mode: string;
+  potential_effect: string;
 }
 
+const emptyNewLine: NewLineInput = {
+  process_step: '',
+  characteristic_id: '',
+  potential_failure_mode: '',
+  potential_effect: '',
+};
+
 export default function PfmeaViewPage({ params }: { params: Promise<{ id: string }> }) {
   const { id: pfmeaId } = use(params);
 
@@ -21,10 +36,17 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
   const [pfmea, setPfmea] = useState<PfmeaHeader | null>(null);
   const [lines, setLines] = useState<PfmeaLine[]>([]);
   const [product, setProduct] = useState<Product | null>(null);
+  const [characteristics, setCharacteristics] = useState<Characteristic[]>([]);
   const [isEditMode, setIsEditMode] = useState(false);
   const [editingLines, setEditingLines] = useState<Map<string, EditingLine>>(new Map());
   const [isPrinting, setIsPrinting] = useState(false);
 
+  // 신규 항목 추가 상태
+  const [showAddForm, setShowAddForm] = useState(false);
+  const [newLine, setNewLine] = useState<NewLineInput>({ ...emptyNewLine });
+  const [aiReviewing, setAiReviewing] = useState(false);
+  const [aiReviewingLineId, setAiReviewingLineId] = useState<string | null>(null);
+
   useEffect(() => {
     setMounted(true);
     if (pfmeaId) {
@@ -32,7 +54,7 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     }
   }, [pfmeaId]);
 
-  async function fetchPfmea() {
+  const fetchPfmea = useCallback(async () => {
     setLoading(true);
     try {
       const headerData = await pfmeaStore.getHeaderById(pfmeaId);
@@ -45,6 +67,8 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
       const productData = await productStore.getById(headerData.product_id);
       if (productData) {
         setProduct(productData);
+        const chars = await characteristicStore.getByProductId(productData.id);
+        setCharacteristics(chars);
       }
 
       const linesData = await pfmeaStore.getLines(pfmeaId);
@@ -53,8 +77,9 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
       console.error('Error fetching PFMEA:', err);
     }
     setLoading(false);
-  }
+  }, [pfmeaId]);
 
+  // ========== 편집 모드 ==========
   const handleEditModeToggle = () => {
     if (isEditMode) {
       setIsEditMode(false);
@@ -70,18 +95,15 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     }
   };
 
-  const handleEditingChange = (lineId: string, field: string, value: any) => {
+  const handleEditingChange = (lineId: string, field: string, value: string | number) => {
     const current = editingLines.get(lineId);
     if (!current) return;
-
     const updated = { ...current, [field]: value };
-
     if (field === 'severity' || field === 'occurrence' || field === 'detection') {
-      const num = Math.max(1, Math.min(10, parseInt(value) || 1));
+      const num = Math.max(1, Math.min(10, parseInt(String(value)) || 1));
       (updated as Record<string, unknown>)[field] = num;
       updated.rpn = updated.severity * updated.occurrence * updated.detection;
     }
-
     editingLines.set(lineId, updated);
     setEditingLines(new Map(editingLines));
   };
@@ -116,10 +138,126 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     setEditingLines(new Map());
   };
 
+  // ========== 항목 삭제 ==========
+  const handleDeleteLine = async (lineId: string) => {
+    if (!confirm('이 항목을 삭제하시겠습니까?')) return;
+    try {
+      await pfmeaStore.deleteLine(lineId);
+      await fetchPfmea();
+    } catch (err) {
+      console.error('Error deleting line:', err);
+    }
+  };
+
+  // ========== 수동 항목 추가 ==========
+  const handleAddLine = async () => {
+    if (!newLine.process_step.trim() || !newLine.potential_failure_mode.trim()) {
+      alert('공정명과 잠재고장모드는 필수입니다.');
+      return;
+    }
+    try {
+      await pfmeaStore.createLine({
+        pfmea_id: pfmeaId,
+        characteristic_id: newLine.characteristic_id || characteristics[0]?.id || '',
+        process_step: newLine.process_step,
+        potential_failure_mode: newLine.potential_failure_mode,
+        potential_effect: newLine.potential_effect || '',
+        severity: 1,
+        potential_cause: '',
+        occurrence: 1,
+        current_control_prevention: '',
+        current_control_detection: '',
+        detection: 1,
+        recommended_action: '',
+      });
+      setNewLine({ ...emptyNewLine });
+      setShowAddForm(false);
+      await fetchPfmea();
+    } catch (err) {
+      console.error('Error adding line:', err);
+    }
+  };
+
+  // ========== AI 검토 (개별 항목) ==========
+  const handleAiReviewLine = async (lineId: string) => {
+    const line = lines.find((l) => l.id === lineId);
+    if (!line) return;
+
+    setAiReviewingLineId(lineId);
+    try {
+      // 특성 정보 가져오기
+      const char = line.characteristic_id
+        ? await characteristicStore.getById(line.characteristic_id)
+        : null;
+
+      // AI 검토 실행
+      const result = aiReviewPfmeaLine({
+        process_step: line.process_step,
+        potential_failure_mode: line.potential_failure_mode,
+        potential_effect: line.potential_effect,
+        characteristic_category: char?.category,
+      });
+
+      // 0.8초 딜레이 (AI 느낌)
+      await new Promise((r) => setTimeout(r, 800));
+
+      await pfmeaStore.updateLine(lineId, result);
+      await fetchPfmea();
+    } catch (err) {
+      console.error('AI review error:', err);
+    }
+    setAiReviewingLineId(null);
+  };
+
+  // ========== 전체 AI 검토 ==========
+  const handleAiReviewAll = async () => {
+    const unreviewedLines = lines.filter(
+      (l) => l.severity <= 1 && l.occurrence <= 1 && l.detection <= 1
+    );
+    if (unreviewedLines.length === 0) {
+      alert('AI 검토가 필요한 항목이 없습니다.\n(S/O/D가 모두 1인 항목만 대상)');
+      return;
+    }
+    setAiReviewing(true);
+    try {
+      for (const line of unreviewedLines) {
+        setAiReviewingLineId(line.id);
+        const char = line.characteristic_id
+          ? await characteristicStore.getById(line.characteristic_id)
+          : null;
+        const result = aiReviewPfmeaLine({
+          process_step: line.process_step,
+          potential_failure_mode: line.potential_failure_mode,
+          potential_effect: line.potential_effect,
+          characteristic_category: char?.category,
+        });
+        await new Promise((r) => setTimeout(r, 500));
+        await pfmeaStore.updateLine(line.id, result);
+      }
+      await fetchPfmea();
+    } catch (err) {
+      console.error('AI review all error:', err);
+    }
+    setAiReviewing(false);
+    setAiReviewingLineId(null);
+  };
+
+  // ========== 상태 변경 ==========
   const handleStatusChange = async (newStatus: 'draft' | 'review' | 'approved') => {
     if (!pfmea) return;
     try {
-      await pfmeaStore.updateHeaderStatus(pfmeaId, newStatus);
+      // 검토 → 승인 시 revision 증가
+      if (newStatus === 'approved' && pfmea.status === 'review') {
+        await pfmeaStore.updateHeader(pfmeaId, {
+          status: newStatus,
+          revision: pfmea.revision + 1,
+          doc_number: product
+            ? generateDocNumber('PFMEA', product.part_number || product.code, pfmea.revision + 1)
+            : pfmea.doc_number,
+        });
+      } else {
+        await pfmeaStore.updateHeaderStatus(pfmeaId, newStatus);
+      }
       await fetchPfmea();
     } catch (err) {
       console.error('Error updating status:', err);
@@ -134,51 +272,24 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     }, 100);
   };
 
+  // ========== 유틸 ==========
   const getStatusBadge = (status: string) => {
     switch (status) {
       case 'approved':
-        return (
-          <span className="px-3 py-1.5 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
-            승인됨
-          </span>
-        );
+        return <span className="px-3 py-1.5 bg-green-100 text-green-700 text-xs font-semibold rounded-full">승인됨</span>;
       case 'review':
-        return (
-          <span className="px-3 py-1.5 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full">
-            검토중
-          </span>
-        );
+        return <span className="px-3 py-1.5 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full">검토중</span>;
       default:
-        return (
-          <span className="px-3 py-1.5 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">
-            초안
-          </span>
-        );
+        return <span className="px-3 py-1.5 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">초안</span>;
     }
   };
 
   const getPriorityBadge = (priority: string | null) => {
     switch (priority) {
-      case 'H':
-        return (
-          <span className="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded">
-            H
-          </span>
-        );
-      case 'M':
-        return (
-          <span className="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded">
-            M
-          </span>
-        );
-      case 'L':
-        return (
-          <span className="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">
-            L
-          </span>
-        );
-      default:
-        return <span className="text-gray-400">-</span>;
+      case 'H': return <span className="inline-block px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded">H</span>;
+      case 'M': return <span className="inline-block px-2 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded">M</span>;
+      case 'L': return <span className="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">L</span>;
+      default: return <span className="text-gray-400">-</span>;
     }
   };
 
@@ -192,12 +303,7 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     return editingLines.get(lineId) || lines.find((l) => l.id === lineId)!;
   };
 
-  if (!mounted) {
-    return <div className="min-h-screen" />;
-  }
-
-  const highRiskCount = lines.filter((l) => l.rpn >= 200).length;
-  const avgRpn = lines.length > 0 ? Math.round(lines.reduce((sum, l) => sum + l.rpn, 0) / lines.length) : 0;
+  if (!mounted) return <div className="min-h-screen" />;
 
   if (loading) {
     return (
@@ -223,78 +329,42 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
     );
   }
 
+  const highRiskCount = lines.filter((l) => l.rpn >= 200).length;
+  const avgRpn = lines.length > 0 ? Math.round(lines.reduce((sum, l) => sum + l.rpn, 0) / lines.length) : 0;
+  const unreviewedCount = lines.filter((l) => l.severity <= 1 && l.occurrence <= 1 && l.detection <= 1).length;
+
   return (
     <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
       <style>{`
         @media print {
-          * {
-            background: white !important;
-            color: black !important;
-            box-shadow: none !important;
-            border-color: #ddd !important;
-          }
-          body {
-            margin: 0;
-            padding: 20px;
-          }
-          .no-print {
-            display: none !important;
-          }
-          .print-header {
-            page-break-after: avoid;
-            margin-bottom: 20px;
-          }
-          .print-table {
-            width: 100%;
-            border-collapse: collapse;
-            font-size: 11px;
-          }
-          .print-table th,
-          .print-table td {
-            border: 1px solid #ddd;
-            padding: 8px;
-            text-align: left;
-          }
-          .print-table th {
-            background-color: #f5f5f5;
-            font-weight: bold;
-          }
-          .print-table tr:nth-child(even) {
-            background-color: #fafafa;
-          }
-          table {
-            page-break-inside: auto;
-          }
-          tr {
-            page-break-inside: avoid;
-          }
+          * { background: white !important; color: black !important; box-shadow: none !important; border-color: #ddd !important; }
+          body { margin: 0; padding: 20px; }
+          .no-print { display: none !important; }
+          .print-table { width: 100%; border-collapse: collapse; font-size: 10px; }
+          .print-table th, .print-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
+          .print-table th { background-color: #f5f5f5; font-weight: bold; }
+          table { page-break-inside: auto; }
+          tr { page-break-inside: avoid; }
         }
       `}</style>
 
+      {/* ===== Header ===== */}
       <header className="sticky top-0 z-40 backdrop-blur-md bg-white/80 border-b border-white/20 shadow-sm">
-        <div className="max-w-7xl mx-auto px-4 py-6">
+        <div className="max-w-7xl mx-auto px-4 py-4">
           <div className="flex items-center justify-between gap-4">
             <div className="flex items-center gap-3">
-              <Link
-                href="/documents/generate"
-                className="no-print p-2 hover:bg-gray-100 rounded-lg transition-colors"
-                title="돌아가기"
-              >
-                <svg
-                  className="w-5 h-5 text-gray-600"
-                  fill="none"
-                  stroke="currentColor"
-                  viewBox="0 0 24 24"
-                >
+              <Link href="/documents/generate" className="no-print p-2 hover:bg-gray-100 rounded-lg transition-colors" title="돌아가기">
+                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                 </svg>
               </Link>
               <div>
                 <h1 className="text-2xl font-bold text-gray-900">PFMEA 분석</h1>
-                <p className="text-sm text-gray-500">{product?.name || '제품'} · {pfmea.process_name}</p>
+                <p className="text-sm text-gray-500">
+                  {pfmea.doc_number || '문서번호 미지정'} · {product?.name || '제품'}
+                </p>
               </div>
             </div>
-
             <div className="flex items-center gap-3">
               {getStatusBadge(pfmea.status)}
               <span className="text-sm text-gray-500">Rev. {pfmea.revision}</span>
@@ -303,82 +373,109 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
         </div>
       </header>
 
-      <main className="max-w-7xl mx-auto px-4 py-8">
-        {/* Control Buttons */}
+      <main className="max-w-7xl mx-auto px-4 py-6">
+
+        {/* ===== 1. 기본정보 헤더 ===== */}
+        <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl shadow-sm mb-6 overflow-hidden">
+          <div className="px-6 py-4 border-b border-gray-200/50 bg-gradient-to-r from-blue-600 to-indigo-600">
+            <h2 className="text-lg font-bold text-white">문서 기본정보</h2>
+          </div>
+          <div className="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-200/50">
+            {[
+              { label: '고객사', value: product?.customer || '-' },
+              { label: '차종', value: product?.vehicle_model || '-' },
+              { label: '품명', value: product?.name || '-' },
+              { label: '품번', value: product?.part_number || product?.code || '-' },
+              { label: '문서번호', value: pfmea.doc_number || '-' },
+              { label: '공정명', value: pfmea.process_name || '-' },
+              { label: 'Rev', value: `${pfmea.revision}` },
+              { label: '작성일', value: new Date(pfmea.created_at).toLocaleDateString('ko-KR') },
+              { label: '최종수정일', value: new Date(pfmea.updated_at).toLocaleDateString('ko-KR') },
+              { label: '작성자', value: pfmea.author || '-' },
+              { label: '상태', value: pfmea.status === 'approved' ? '승인됨' : pfmea.status === 'review' ? '검토중' : '초안' },
+              { label: '제품코드', value: product?.code || '-' },
+            ].map((item, i) => (
+              <div key={i} className="bg-white px-4 py-3">
+                <div className="text-xs font-medium text-gray-500 mb-1">{item.label}</div>
+                <div className="text-sm font-semibold text-gray-900 truncate">{item.value}</div>
+              </div>
+            ))}
+          </div>
+        </div>
+
+        {/* ===== 2. 컨트롤 버튼 ===== */}
         <div className="no-print flex gap-3 mb-6 flex-wrap">
           {pfmea.status !== 'approved' && (
-            <button
-              onClick={handleEditModeToggle}
-              className={`px-4 py-2 rounded-lg font-medium transition-all ${
-                isEditMode
-                  ? 'bg-red-100 text-red-700 hover:bg-red-200'
-                  : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
-              }`}
-            >
-              {isEditMode ? '취소' : '편집'}
-            </button>
-          )}
-
-          {isEditMode && (
             <>
               <button
-                onClick={handleSaveChanges}
-                className="px-4 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg font-medium transition-all"
+                onClick={handleEditModeToggle}
+                className={`px-4 py-2 rounded-lg font-medium transition-all ${
+                  isEditMode ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
+                }`}
               >
-                저장
-              </button>
-              <button
-                onClick={handleCancel}
-                className="px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all"
-              >
-                취소
+                {isEditMode ? '편집 취소' : '편집'}
               </button>
+
+              {!isEditMode && (
+                <button
+                  onClick={() => setShowAddForm(!showAddForm)}
+                  className="px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg font-medium transition-all flex items-center gap-1"
+                >
+                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
+                  </svg>
+                  항목 추가
+                </button>
+              )}
+
+              {!isEditMode && unreviewedCount > 0 && (
+                <button
+                  onClick={handleAiReviewAll}
+                  disabled={aiReviewing}
+                  className="px-4 py-2 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded-lg font-medium transition-all flex items-center gap-2 disabled:opacity-50"
+                >
+                  {aiReviewing ? (
+                    <>
+                      <div className="w-4 h-4 rounded-full border-2 border-purple-300 border-t-purple-700 animate-spin"></div>
+                      AI 검토 중...
+                    </>
+                  ) : (
+                    <>
+                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
+                      </svg>
+                      AI 전체 검토 ({unreviewedCount}건)
+                    </>
+                  )}
+                </button>
+              )}
+            </>
+          )}
+
+          {isEditMode && (
+            <>
+              <button onClick={handleSaveChanges} className="px-4 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg font-medium transition-all">저장</button>
+              <button onClick={handleCancel} className="px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all">취소</button>
             </>
           )}
 
           {!isEditMode && (
             <>
               {pfmea.status === 'draft' && (
-                <button
-                  onClick={() => handleStatusChange('review')}
-                  className="px-4 py-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg font-medium transition-all"
-                >
-                  검토 요청
-                </button>
+                <button onClick={() => handleStatusChange('review')} className="px-4 py-2 bg-yellow-100 text-yellow-700 hover:bg-yellow-200 rounded-lg font-medium transition-all">검토 요청</button>
               )}
-
               {pfmea.status === 'review' && (
                 <>
-                  <button
-                    onClick={() => handleStatusChange('approved')}
-                    className="px-4 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg font-medium transition-all"
-                  >
-                    승인
-                  </button>
-                  <button
-                    onClick={() => handleStatusChange('draft')}
-                    className="px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all"
-                  >
-                    초안으로
-                  </button>
+                  <button onClick={() => handleStatusChange('approved')} className="px-4 py-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-lg font-medium transition-all">승인</button>
+                  <button onClick={() => handleStatusChange('draft')} className="px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg font-medium transition-all">초안으로</button>
                 </>
               )}
-
               {pfmea.status === 'approved' && (
-                <button
-                  onClick={() => handleStatusChange('draft')}
-                  className="px-4 py-2 bg-orange-100 text-orange-700 hover:bg-orange-200 rounded-lg font-medium transition-all"
-                >
-                  수정하기
-                </button>
+                <button onClick={() => handleStatusChange('draft')} className="px-4 py-2 bg-orange-100 text-orange-700 hover:bg-orange-200 rounded-lg font-medium transition-all">수정하기</button>
               )}
-
-              <button
-                onClick={handlePdfDownload}
-                className="px-4 py-2 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg font-medium transition-all flex items-center gap-2"
-              >
+              <button onClick={handlePdfDownload} className="px-4 py-2 bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg font-medium transition-all flex items-center gap-2">
                 <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
-                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8m0 8l-9-2m9 2l9-2m-9-8l9 2m-9-2l-9 2" />
+                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                 </svg>
                 PDF 다운로드
               </button>
@@ -386,29 +483,107 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
           )}
         </div>
 
-        {/* Summary Statistics */}
-        <div className="no-print grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
-          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-6 shadow-sm">
-            <div className="text-sm font-medium text-gray-600 mb-2">총 분석 항목</div>
-            <div className="text-3xl font-bold text-blue-600">{lines.length}</div>
+        {/* ===== 3. 항목 추가 폼 ===== */}
+        {showAddForm && (
+          <div className="no-print bg-white/90 backdrop-blur-md border-2 border-emerald-200 rounded-2xl shadow-lg mb-6 p-6">
+            <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
+              <svg className="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
+              </svg>
+              새 분석 항목 추가
+            </h3>
+            <p className="text-sm text-gray-500 mb-4">
+              공정, 잠재고장모드, 잠재영향을 입력하면 <strong className="text-purple-600">AI가 나머지를 자동 완성</strong>합니다.
+            </p>
+            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
+              <div>
+                <label className="block text-sm font-semibold text-gray-700 mb-1">공정 <span className="text-red-500">*</span></label>
+                <input
+                  type="text"
+                  value={newLine.process_step}
+                  onChange={(e) => setNewLine({ ...newLine, process_step: e.target.value })}
+                  placeholder="예: 선반 가공, 조립, 용접..."
+                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-sm"
+                />
+              </div>
+              <div>
+                <label className="block text-sm font-semibold text-gray-700 mb-1">관련 특성</label>
+                <select
+                  value={newLine.characteristic_id}
+                  onChange={(e) => setNewLine({ ...newLine, characteristic_id: e.target.value })}
+                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-sm"
+                >
+                  <option value="">선택 안함</option>
+                  {characteristics.map((c) => (
+                    <option key={c.id} value={c.id}>
+                      {c.name} ({c.category === 'critical' ? '★ Critical' : c.category === 'major' ? 'Major' : 'Minor'})
+                    </option>
+                  ))}
+                </select>
+              </div>
+              <div>
+                <label className="block text-sm font-semibold text-gray-700 mb-1">잠재고장모드 <span className="text-red-500">*</span></label>
+                <input
+                  type="text"
+                  value={newLine.potential_failure_mode}
+                  onChange={(e) => setNewLine({ ...newLine, potential_failure_mode: e.target.value })}
+                  placeholder="예: 치수 규격 이탈, 부품 누락, 표면 스크래치..."
+                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-sm"
+                />
+              </div>
+              <div>
+                <label className="block text-sm font-semibold text-gray-700 mb-1">잠재영향</label>
+                <input
+                  type="text"
+                  value={newLine.potential_effect}
+                  onChange={(e) => setNewLine({ ...newLine, potential_effect: e.target.value })}
+                  placeholder="예: 조립 불량, 기능 불량, 외관 불량..."
+                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent text-sm"
+                />
+              </div>
+            </div>
+            <div className="flex gap-3 mt-5">
+              <button
+                onClick={handleAddLine}
+                className="px-5 py-2.5 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-all"
+              >
+                항목 추가
+              </button>
+              <button
+                onClick={() => { setShowAddForm(false); setNewLine({ ...emptyNewLine }); }}
+                className="px-5 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-all"
+              >
+                취소
+              </button>
+            </div>
+          </div>
+        )}
+
+        {/* ===== 4. 요약 통계 ===== */}
+        <div className="no-print grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
+          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-5 shadow-sm">
+            <div className="text-xs font-medium text-gray-500 mb-1">총 항목</div>
+            <div className="text-2xl font-bold text-blue-600">{lines.length}</div>
           </div>
-          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-6 shadow-sm">
-            <div className="text-sm font-medium text-gray-600 mb-2">고위험 (RPN ≥200)</div>
-            <div className="text-3xl font-bold text-red-600">{highRiskCount}</div>
+          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-5 shadow-sm">
+            <div className="text-xs font-medium text-gray-500 mb-1">고위험 (≥200)</div>
+            <div className="text-2xl font-bold text-red-600">{highRiskCount}</div>
           </div>
-          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-6 shadow-sm">
-            <div className="text-sm font-medium text-gray-600 mb-2">중위험 (RPN ≥100)</div>
-            <div className="text-3xl font-bold text-orange-600">
-              {lines.filter((l) => l.rpn >= 100 && l.rpn < 200).length}
-            </div>
+          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-5 shadow-sm">
+            <div className="text-xs font-medium text-gray-500 mb-1">중위험 (≥100)</div>
+            <div className="text-2xl font-bold text-orange-600">{lines.filter((l) => l.rpn >= 100 && l.rpn < 200).length}</div>
           </div>
-          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-6 shadow-sm">
-            <div className="text-sm font-medium text-gray-600 mb-2">평균 RPN</div>
-            <div className="text-3xl font-bold text-gray-600">{avgRpn}</div>
+          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-5 shadow-sm">
+            <div className="text-xs font-medium text-gray-500 mb-1">평균 RPN</div>
+            <div className="text-2xl font-bold text-gray-600">{avgRpn}</div>
+          </div>
+          <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl p-5 shadow-sm">
+            <div className="text-xs font-medium text-gray-500 mb-1">AI 검토 대기</div>
+            <div className="text-2xl font-bold text-purple-600">{unreviewedCount}</div>
           </div>
         </div>
 
-        {/* PFMEA Table */}
+        {/* ===== 5. PFMEA 테이블 ===== */}
         <div className="bg-white/70 backdrop-blur-md border border-white/20 rounded-2xl shadow-sm overflow-hidden">
           <div className="px-6 py-4 border-b border-gray-200/50">
             <h2 className="text-lg font-semibold text-gray-900">PFMEA 분석 항목</h2>
@@ -416,241 +591,197 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
           </div>
 
           {lines.length === 0 ? (
-            <div className="p-8 text-center">
-              <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 mb-4">
-                <svg className="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
-                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
+            <div className="p-12 text-center">
+              <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-emerald-50 mb-4">
+                <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                 </svg>
               </div>
-              <p className="text-gray-500 font-medium">PFMEA 항목이 없습니다</p>
+              <p className="text-gray-600 font-medium mb-2">분석 항목이 없습니다</p>
+              <p className="text-sm text-gray-400 mb-4">위의 &quot;항목 추가&quot; 버튼으로 공정/고장모드를 입력하세요</p>
+              <button
+                onClick={() => setShowAddForm(true)}
+                className="no-print px-5 py-2.5 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition-all"
+              >
+                첫 항목 추가하기
+              </button>
             </div>
           ) : (
             <div className="overflow-x-auto">
               <table className={`w-full text-sm ${isPrinting ? 'print-table' : ''}`}>
                 <thead className="bg-gray-50/80 border-b border-gray-200/50">
                   <tr>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">No</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">공정</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">특성명</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">잠재고장모드</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">잠재영향</th>
-                    <th className="px-4 py-3 text-center font-semibold text-gray-700">S</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">원인</th>
-                    <th className="px-4 py-3 text-center font-semibold text-gray-700">O</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">예방관리</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">검출관리</th>
-                    <th className="px-4 py-3 text-center font-semibold text-gray-700">D</th>
-                    <th className="px-4 py-3 text-center font-semibold text-gray-700">RPN</th>
-                    <th className="px-4 py-3 text-center font-semibold text-gray-700">우선순위</th>
-                    <th className="px-4 py-3 text-left font-semibold text-gray-700">권장조치</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">No</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">공정</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">특성명</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">잠재고장모드</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">잠재영향</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700">S</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">원인</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700">O</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">예방관리</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">검출관리</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700">D</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700">RPN</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700">AP</th>
+                    <th className="px-3 py-3 text-left font-semibold text-gray-700">권장조치</th>
+                    <th className="px-3 py-3 text-center font-semibold text-gray-700 no-print">액션</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-200/50">
-                  {lines.map((line) => {
+                  {lines.map((line, idx) => {
                     const displayLine = getDisplayLine(line.id);
                     const rpn = displayLine.rpn;
+                    const isUnreviewed = line.severity <= 1 && line.occurrence <= 1 && line.detection <= 1;
+                    const isReviewing = aiReviewingLineId === line.id;
 
                     return (
-                      <tr key={line.id} className="hover:bg-blue-50/50 transition-colors">
-                        <td className="px-4 py-3 text-gray-700 font-medium">{lines.indexOf(line) + 1}</td>
+                      <tr
+                        key={line.id}
+                        className={`transition-colors ${
+                          isReviewing
+                            ? 'bg-purple-50 animate-pulse'
+                            : isUnreviewed
+                            ? 'bg-yellow-50/50'
+                            : 'hover:bg-blue-50/50'
+                        }`}
+                      >
+                        <td className="px-3 py-3 text-gray-700 font-medium">{idx + 1}</td>
 
                         {/* 공정 */}
-                        <td className="px-4 py-3">
+                        <td className="px-3 py-3">
                           {isEditMode ? (
-                            <input
-                              type="text"
-                              value={displayLine.process_step}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'process_step', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded font-medium"
-                            />
+                            <input type="text" value={displayLine.process_step} onChange={(e) => handleEditingChange(line.id, 'process_step', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded font-medium text-sm" />
                           ) : (
                             <span className="font-medium text-gray-900">{displayLine.process_step}</span>
                           )}
                         </td>
 
                         {/* 특성명 */}
-                        <td className="px-4 py-3 text-sm">
-                          {line.characteristic_id ? (
-                            <CharName charId={line.characteristic_id} />
-                          ) : (
-                            <span className="text-gray-400">-</span>
-                          )}
+                        <td className="px-3 py-3 text-sm">
+                          {line.characteristic_id ? <CharName charId={line.characteristic_id} /> : <span className="text-gray-400">-</span>}
                         </td>
 
                         {/* 잠재고장모드 */}
-                        <td className="px-4 py-3">
+                        <td className="px-3 py-3">
                           {isEditMode ? (
-                            <textarea
-                              value={displayLine.potential_failure_mode}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'potential_failure_mode', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
-                              rows={2}
-                            />
+                            <textarea value={displayLine.potential_failure_mode} onChange={(e) => handleEditingChange(line.id, 'potential_failure_mode', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" rows={2} />
                           ) : (
-                            <span className="text-red-700 font-medium">{displayLine.potential_failure_mode}</span>
+                            <span className="text-red-700 font-medium text-xs">{displayLine.potential_failure_mode}</span>
                           )}
                         </td>
 
                         {/* 잠재영향 */}
-                        <td className="px-4 py-3">
+                        <td className="px-3 py-3">
                           {isEditMode ? (
-                            <textarea
-                              value={displayLine.potential_effect}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'potential_effect', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
-                              rows={2}
-                            />
+                            <textarea value={displayLine.potential_effect} onChange={(e) => handleEditingChange(line.id, 'potential_effect', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" rows={2} />
                           ) : (
-                            <span className="text-gray-700">{displayLine.potential_effect}</span>
+                            <span className="text-gray-700 text-xs">{displayLine.potential_effect || '-'}</span>
                           )}
                         </td>
 
                         {/* S */}
-                        <td className="px-4 py-3 text-center">
+                        <td className="px-3 py-3 text-center">
                           {isEditMode ? (
-                            <input
-                              type="number"
-                              min="1"
-                              max="10"
-                              value={displayLine.severity}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'severity', e.target.value)
-                              }
-                              className="w-12 px-2 py-1 border border-gray-300 rounded text-center font-semibold"
-                            />
+                            <input type="number" min="1" max="10" value={displayLine.severity} onChange={(e) => handleEditingChange(line.id, 'severity', e.target.value)} className="w-12 px-1 py-1 border border-gray-300 rounded text-center font-semibold text-sm" />
                           ) : (
-                            <span className="font-semibold text-gray-900">{displayLine.severity}</span>
+                            <span className={`font-semibold ${displayLine.severity >= 8 ? 'text-red-600' : 'text-gray-900'}`}>{displayLine.severity}</span>
                           )}
                         </td>
 
                         {/* 원인 */}
-                        <td className="px-4 py-3">
+                        <td className="px-3 py-3">
                           {isEditMode ? (
-                            <textarea
-                              value={displayLine.potential_cause}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'potential_cause', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
-                              rows={2}
-                            />
+                            <textarea value={displayLine.potential_cause} onChange={(e) => handleEditingChange(line.id, 'potential_cause', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" rows={2} />
                           ) : (
-                            <span className="text-gray-700">{displayLine.potential_cause}</span>
+                            <span className="text-gray-700 text-xs">{displayLine.potential_cause || '-'}</span>
                           )}
                         </td>
 
                         {/* O */}
-                        <td className="px-4 py-3 text-center">
+                        <td className="px-3 py-3 text-center">
                           {isEditMode ? (
-                            <input
-                              type="number"
-                              min="1"
-                              max="10"
-                              value={displayLine.occurrence}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'occurrence', e.target.value)
-                              }
-                              className="w-12 px-2 py-1 border border-gray-300 rounded text-center font-semibold"
-                            />
+                            <input type="number" min="1" max="10" value={displayLine.occurrence} onChange={(e) => handleEditingChange(line.id, 'occurrence', e.target.value)} className="w-12 px-1 py-1 border border-gray-300 rounded text-center font-semibold text-sm" />
                           ) : (
                             <span className="font-semibold text-gray-900">{displayLine.occurrence}</span>
                           )}
                         </td>
 
                         {/* 예방관리 */}
-                        <td className="px-4 py-3 text-xs">
+                        <td className="px-3 py-3 text-xs">
                           {isEditMode ? (
-                            <input
-                              type="text"
-                              value={displayLine.current_control_prevention || ''}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'current_control_prevention', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded"
-                            />
+                            <input type="text" value={displayLine.current_control_prevention || ''} onChange={(e) => handleEditingChange(line.id, 'current_control_prevention', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" />
                           ) : (
                             <span className="text-gray-700">{displayLine.current_control_prevention || '-'}</span>
                           )}
                         </td>
 
                         {/* 검출관리 */}
-                        <td className="px-4 py-3 text-xs">
+                        <td className="px-3 py-3 text-xs">
                           {isEditMode ? (
-                            <input
-                              type="text"
-                              value={displayLine.current_control_detection || ''}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'current_control_detection', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded"
-                            />
+                            <input type="text" value={displayLine.current_control_detection || ''} onChange={(e) => handleEditingChange(line.id, 'current_control_detection', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" />
                           ) : (
                             <span className="text-gray-700">{displayLine.current_control_detection || '-'}</span>
                           )}
                         </td>
 
                         {/* D */}
-                        <td className="px-4 py-3 text-center">
+                        <td className="px-3 py-3 text-center">
                           {isEditMode ? (
-                            <input
-                              type="number"
-                              min="1"
-                              max="10"
-                              value={displayLine.detection}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'detection', e.target.value)
-                              }
-                              className="w-12 px-2 py-1 border border-gray-300 rounded text-center font-semibold"
-                            />
+                            <input type="number" min="1" max="10" value={displayLine.detection} onChange={(e) => handleEditingChange(line.id, 'detection', e.target.value)} className="w-12 px-1 py-1 border border-gray-300 rounded text-center font-semibold text-sm" />
                           ) : (
                             <span className="font-semibold text-gray-900">{displayLine.detection}</span>
                           )}
                         </td>
 
                         {/* RPN */}
-                        <td className={`px-4 py-3 text-center ${getRpnColor(rpn)}`}>{rpn}</td>
+                        <td className={`px-3 py-3 text-center ${getRpnColor(rpn)}`}>{rpn}</td>
 
-                        {/* 우선순위 */}
-                        <td className="px-4 py-3 text-center">
+                        {/* AP */}
+                        <td className="px-3 py-3 text-center">
                           {isEditMode ? (
-                            <select
-                              value={displayLine.action_priority || ''}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'action_priority', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded text-center"
-                            >
+                            <select value={displayLine.action_priority || ''} onChange={(e) => handleEditingChange(line.id, 'action_priority', e.target.value)} className="w-14 px-1 py-1 border border-gray-300 rounded text-center text-xs">
                               <option value="">-</option>
                               <option value="H">H</option>
                               <option value="M">M</option>
                               <option value="L">L</option>
                             </select>
-                          ) : (
-                            getPriorityBadge(displayLine.action_priority)
-                          )}
+                          ) : getPriorityBadge(displayLine.action_priority)}
                         </td>
 
                         {/* 권장조치 */}
-                        <td className="px-4 py-3 text-xs">
+                        <td className="px-3 py-3 text-xs">
                           {isEditMode ? (
-                            <textarea
-                              value={displayLine.recommended_action || ''}
-                              onChange={(e) =>
-                                handleEditingChange(line.id, 'recommended_action', e.target.value)
-                              }
-                              className="w-full px-2 py-1 border border-gray-300 rounded text-xs"
-                              rows={2}
-                            />
+                            <textarea value={displayLine.recommended_action || ''} onChange={(e) => handleEditingChange(line.id, 'recommended_action', e.target.value)} className="w-full px-2 py-1 border border-gray-300 rounded text-xs" rows={2} />
                           ) : (
                             <span className="text-gray-700">{displayLine.recommended_action || '-'}</span>
                           )}
                         </td>
+
+                        {/* 액션 버튼 */}
+                        <td className="px-3 py-3 text-center no-print">
+                          <div className="flex flex-col gap-1">
+                            {isUnreviewed && !isEditMode && (
+                              <button
+                                onClick={() => handleAiReviewLine(line.id)}
+                                disabled={isReviewing}
+                                className="px-2 py-1 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded text-xs font-medium transition-all disabled:opacity-50"
+                                title="AI 검토"
+                              >
+                                {isReviewing ? '검토중...' : 'AI 검토'}
+                              </button>
+                            )}
+                            {!isEditMode && pfmea.status !== 'approved' && (
+                              <button
+                                onClick={() => handleDeleteLine(line.id)}
+                                className="px-2 py-1 bg-red-50 text-red-500 hover:bg-red-100 rounded text-xs font-medium transition-all"
+                                title="삭제"
+                              >
+                                삭제
+                              </button>
+                            )}
+                          </div>
+                        </td>
                       </tr>
                     );
                   })}
@@ -660,7 +791,7 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
           )}
         </div>
 
-        {/* Footer Info */}
+        {/* ===== Footer ===== */}
         <div className="no-print mt-6 text-center text-sm text-gray-500">
           <p>최종 업데이트: {new Date(pfmea.updated_at).toLocaleString('ko-KR')}</p>
         </div>
@@ -670,17 +801,20 @@ export default function PfmeaViewPage({ params }: { params: Promise<{ id: string
 }
 
 function CharName({ charId }: { charId: string }) {
-  const [char, setChar] = useState<{ name: string; type: string } | null>(null);
+  const [char, setChar] = useState<{ name: string; type: string; category: string } | null>(null);
   useEffect(() => {
     characteristicStore.getById(charId).then((c) => {
-      if (c) setChar({ name: c.name, type: c.type });
+      if (c) setChar({ name: c.name, type: c.type, category: c.category });
     });
   }, [charId]);
   if (!char) return <span className="text-gray-400">-</span>;
   return (
     <div>
       <div className="font-medium text-gray-900">{char.name}</div>
-      <div className="text-xs text-gray-500">{char.type === 'product' ? '제품' : '공정'}</div>
+      <div className="text-xs text-gray-500">
+        {char.type === 'product' ? '제품' : '공정'}
+        {char.category === 'critical' && <span className="ml-1 text-red-600 font-bold">★</span>}
+      </div>
     </div>
   );
 }
diff --git a/src/app/products/new/page.tsx b/src/app/products/new/page.tsx
index 19a88de..ee4a752 100644
--- a/src/app/products/new/page.tsx
+++ b/src/app/products/new/page.tsx
@@ -27,6 +27,8 @@ export default function NewProductPage() {
   const [productName, setProductName] = useState('');
   const [productCode, setProductCode] = useState('');
   const [customer, setCustomer] = useState('');
+  const [vehicleModel, setVehicleModel] = useState('');
+  const [partNumber, setPartNumber] = useState('');
   const [description, setDescription] = useState('');
 
   // Step 2: Characteristics
@@ -98,6 +100,8 @@ export default function NewProductPage() {
         name: productName,
         code: productCode,
         customer: customer || '',
+        vehicle_model: vehicleModel || '',
+        part_number: partNumber || '',
         description: description || ''
       });
 
@@ -204,13 +208,37 @@ export default function NewProductPage() {
                 />
               </div>
 
+              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
+                <div>
+                  <label className="block text-sm font-semibold text-gray-900 mb-2">고객사</label>
+                  <input
+                    type="text"
+                    value={customer}
+                    onChange={(e) => setCustomer(e.target.value)}
+                    placeholder="예: ABC 자동차"
+                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
+                  />
+                </div>
+
+                <div>
+                  <label className="block text-sm font-semibold text-gray-900 mb-2">차종</label>
+                  <input
+                    type="text"
+                    value={vehicleModel}
+                    onChange={(e) => setVehicleModel(e.target.value)}
+                    placeholder="예: KN4 (셀토스)"
+                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
+                  />
+                </div>
+              </div>
+
               <div>
-                <label className="block text-sm font-semibold text-gray-900 mb-2">고객사</label>
+                <label className="block text-sm font-semibold text-gray-900 mb-2">품번</label>
                 <input
                   type="text"
-                  value={customer}
-                  onChange={(e) => setCustomer(e.target.value)}
-                  placeholder="예: ABC 자동차"
+                  value={partNumber}
+                  onChange={(e) => setPartNumber(e.target.value)}
+                  placeholder="예: 12345-AB100"
                   className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                 />
               </div>
diff --git a/src/lib/store.ts b/src/lib/store.ts
index 90f99ec..3faa310 100644
--- a/src/lib/store.ts
+++ b/src/lib/store.ts
@@ -10,6 +10,8 @@ export interface Product {
   name: string;
   code: string;
   customer: string;
+  vehicle_model: string;
+  part_number: string;
   description: string;
   status: 'active' | 'inactive';
   created_at: string;
@@ -35,6 +37,8 @@ export interface PfmeaHeader {
   id: string;
   product_id: string;
   process_name: string;
+  doc_number: string;
+  author: string;
   revision: number;
   status: 'draft' | 'review' | 'approved';
   created_at: string;
@@ -65,6 +69,8 @@ export interface ControlPlan {
   pfmea_id: string;
   product_id: string;
   name: string;
+  doc_number: string;
+  author: string;
   revision: number;
   status: 'draft' | 'review' | 'approved';
   created_at: string;
@@ -92,6 +98,8 @@ export interface Sop {
   control_plan_id: string;
   product_id: string;
   name: string;
+  doc_number: string;
+  author: string;
   revision: number;
   status: 'draft' | 'review' | 'approved';
   created_at: string;
@@ -118,6 +126,8 @@ export interface InspectionStandard {
   control_plan_id: string;
   product_id: string;
   name: string;
+  doc_number: string;
+  author: string;
   revision: number;
   status: 'draft' | 'review' | 'approved';
   created_at: string;
@@ -305,6 +315,22 @@ export const pfmeaStore = {
     return data;
   },
 
+  updateHeader: async (id: string, input: Partial<PfmeaHeader>): Promise<PfmeaHeader | null> => {
+    const { data, error } = await supabase
+      .from('pfmea_headers')
+      .update(input)
+      .eq('id', id)
+      .select()
+      .single();
+    if (error) return null;
+    return data;
+  },
+
+  deleteLine: async (id: string): Promise<boolean> => {
+    const { error } = await supabase.from('pfmea_lines').delete().eq('id', id);
+    return !error;
+  },
+
   createLine: async (input: Omit<PfmeaLine, 'id' | 'created_at' | 'rpn' | 'action_priority'>): Promise<PfmeaLine> => {
     const rpn = input.severity * input.occurrence * input.detection;
     const action_priority = rpn >= 200 ? 'H' : rpn >= 100 ? 'M' : 'L';
@@ -539,6 +565,119 @@ export const statsStore = {
 
 // ============ AI 문서 생성 (규칙 기반) ============
 
+// ============ 문서번호 자동 생성 ============
+
+export function generateDocNumber(prefix: string, partNumber: string, revision: number): string {
+  const now = new Date();
+  const yy = String(now.getFullYear()).slice(-2);
+  const mm = String(now.getMonth() + 1).padStart(2, '0');
+  const pn = partNumber || 'NOPN';
+  return `${prefix}-${pn}-${yy}${mm}-R${String(revision).padStart(2, '0')}`;
+}
+
+// ============ AI 검토 (규칙기반 자동 완성) ============
+
+export function aiReviewPfmeaLine(input: {
+  process_step: string;
+  potential_failure_mode: string;
+  potential_effect: string;
+  characteristic_category?: string;
+}): {
+  severity: number;
+  potential_cause: string;
+  occurrence: number;
+  current_control_prevention: string;
+  current_control_detection: string;
+  detection: number;
+  recommended_action: string;
+} {
+  const effect = input.potential_effect;
+  const mode = input.potential_failure_mode;
+  const step = input.process_step;
+  const cat = input.characteristic_category;
+
+  // --- Severity 판정 (잠재영향 + 특성등급 기반) ---
+  let severity = 5;
+  if (/안전|법규|화재|인체|사고/i.test(effect)) severity = 10;
+  else if (/기능.*불량|작동.*불가|고객.*불만/i.test(effect)) severity = 8;
+  else if (/조립.*불량|성능.*저하|누수|누유/i.test(effect)) severity = 7;
+  else if (/품질.*저하|이슈|리워크|재작업/i.test(effect)) severity = 6;
+  else if (/외관|소음|진동/i.test(effect)) severity = 4;
+  else if (/경미|미미/i.test(effect)) severity = 2;
+  // 특성등급 보정
+  if (cat === 'critical') severity = Math.max(severity, 9);
+  else if (cat === 'major') severity = Math.max(severity, 7);
+
+  // --- Potential Cause 생성 ---
+  const causes: string[] = [];
+  if (/가공|절삭|선반|밀링|드릴/i.test(step)) {
+    causes.push(`${step} 공정 변동`, '공구 마모', '설비 이상');
+  } else if (/조립|체결|삽입/i.test(step)) {
+    causes.push('체결 토크 변동', '부품 누락', '작업자 실수');
+  } else if (/용접|웰딩/i.test(step)) {
+    causes.push('용접 조건 변동', '전극 마모', '모재 상태 불량');
+  } else if (/도장|코팅|표면/i.test(step)) {
+    causes.push('도장 조건 변동', '환경 온습도', '전처리 불량');
+  } else if (/검사|측정/i.test(step)) {
+    causes.push('측정기 오차', '검사 기준 모호', '작업자 판정 오류');
+  } else {
+    causes.push(`${step} 공정 변동`, '설비 이상', '작업자 실수');
+  }
+  const potential_cause = causes.join(', ');
+
+  // --- Occurrence 판정 ---
+  let occurrence = 4;
+  if (/규격.*이탈|치수.*불량|편차/i.test(mode)) occurrence = 5;
+  else if (/누락|빠짐|미삽입/i.test(mode)) occurrence = 3;
+  else if (/파손|크랙|균열/i.test(mode)) occurrence = 3;
+  else if (/오염|이물/i.test(mode)) occurrence = 4;
+  else if (/변형|뒤틀림/i.test(mode)) occurrence = 4;
+
+  // --- 예방관리 생성 ---
+  let current_control_prevention = '작업표준서 준수, 정기 점검';
+  if (/가공|절삭/i.test(step)) current_control_prevention = '공정 조건 표준화, 공구 수명 관리, 정기 설비 점검';
+  else if (/조립|체결/i.test(step)) current_control_prevention = '토크 렌치 사용, 작업표준서 준수, Poka-Yoke 적용';
+  else if (/용접/i.test(step)) current_control_prevention = '용접 파라미터 관리, 전극 교체 주기 관리';
+  else if (/도장|코팅/i.test(step)) current_control_prevention = '도장 조건 관리, 환경 온습도 관리, 전처리 확인';
+
+  // --- 검출관리 생성 ---
+  let current_control_detection = '육안 검사, 측정 검사';
+  if (/치수|규격|길이|직경|두께/i.test(mode)) current_control_detection = '측정기기(캘리퍼/마이크로미터) 검사, SPC 모니터링';
+  else if (/외관|스크래치|찍힘/i.test(mode)) current_control_detection = '육안 검사, 한도 샘플 비교';
+  else if (/누락|빠짐/i.test(mode)) current_control_detection = 'Poka-Yoke 감지, 중량 검사';
+  else if (/토크|체결/i.test(mode)) current_control_detection = '토크 검사기, 마킹 확인';
+
+  // --- Detection 판정 ---
+  let detection = 5;
+  if (/전수|자동|센서|Poka-Yoke/i.test(current_control_detection)) detection = 3;
+  else if (/SPC|모니터링/i.test(current_control_detection)) detection = 4;
+  else if (/육안/i.test(current_control_detection)) detection = 6;
+  else if (/샘플링/i.test(current_control_detection)) detection = 7;
+
+  // --- 권장조치 생성 (Severity 기반) ---
+  let recommended_action: string;
+  const rpn = severity * occurrence * detection;
+  if (severity >= 9 || rpn >= 200) {
+    recommended_action = 'SPC 관리 도입, 공정능력(Cpk) 확인, 전수검사 실시, 설계 검토 요청';
+  } else if (severity >= 7 || rpn >= 100) {
+    recommended_action = '정기 검사 주기 단축, 작업자 교육 강화, 샘플링 검사 강화';
+  } else {
+    recommended_action = '작업자 자주검사 실시, 한도 샘플 관리, 정기 모니터링';
+  }
+
+  return {
+    severity,
+    potential_cause,
+    occurrence,
+    current_control_prevention,
+    current_control_detection,
+    detection,
+    recommended_action,
+  };
+}
+
+// ============ AI 문서 생성 (규칙 기반) ============
+
 export async function generatePfmeaForProduct(productId: string): Promise<{ header: PfmeaHeader; lines: PfmeaLine[] }> {
   const product = await productStore.getById(productId);
   const chars = await characteristicStore.getByProductId(productId);
diff --git a/supabase/migration_v2.sql b/supabase/migration_v2.sql
new file mode 100644
index 0000000..94ac11f
--- /dev/null
+++ b/supabase/migration_v2.sql
@@ -0,0 +1,24 @@
+-- ================================================
+-- APQP v2 마이그레이션 - 차종/품번/문서번호/작성자 추가
+-- Supabase SQL Editor에서 실행하세요
+-- ================================================
+
+-- 1. products 테이블에 차종, 품번 추가
+ALTER TABLE products ADD COLUMN IF NOT EXISTS vehicle_model TEXT NOT NULL DEFAULT '';
+ALTER TABLE products ADD COLUMN IF NOT EXISTS part_number TEXT NOT NULL DEFAULT '';
+
+-- 2. 모든 문서 헤더에 문서번호, 작성자 추가
+ALTER TABLE pfmea_headers ADD COLUMN IF NOT EXISTS doc_number TEXT NOT NULL DEFAULT '';
+ALTER TABLE pfmea_headers ADD COLUMN IF NOT EXISTS author TEXT NOT NULL DEFAULT '';
+
+ALTER TABLE control_plans ADD COLUMN IF NOT EXISTS doc_number TEXT NOT NULL DEFAULT '';
+ALTER TABLE control_plans ADD COLUMN IF NOT EXISTS author TEXT NOT NULL DEFAULT '';
+
+ALTER TABLE sops ADD COLUMN IF NOT EXISTS doc_number TEXT NOT NULL DEFAULT '';
+ALTER TABLE sops ADD COLUMN IF NOT EXISTS author TEXT NOT NULL DEFAULT '';
+
+ALTER TABLE inspection_standards ADD COLUMN IF NOT EXISTS doc_number TEXT NOT NULL DEFAULT '';
+ALTER TABLE inspection_standards ADD COLUMN IF NOT EXISTS author TEXT NOT NULL DEFAULT '';
+
+-- 3. 스키마 캐시 새로고침
+NOTIFY pgrst, 'reload schema';
-- 
2.34.1

